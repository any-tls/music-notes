<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SEKAI GEN - Ultimate AI Rhythm</title>
    <style>
        /* --- CSS Reset & Variables --- */
        :root {
            --primary: #33d5ac;
            --primary-dark: #209c7d;
            --accent: #ff007c;
            --long: #fdbb2d;
            --bg: #000;
            --font-main: 'Helvetica Neue', Arial, sans-serif;
        }
        
        /* ÂæπÂ∫ïÁöÑ„Å™Èï∑Êäº„Åó„É°„Éã„É•„Éº„ÉªÈÅ∏Êäû„Éª„Ç∫„Éº„É†Èò≤Ê≠¢ */
        * {
            box-sizing: border-box;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none; /* iOSÈï∑Êäº„Åó„É°„Éã„É•„ÉºÁÑ°ÂäπÂåñ */
            -webkit-tap-highlight-color: transparent;
        }

        body { margin: 0; overflow: hidden; background: #000; font-family: var(--font-main); color: white; }

        /* --- Layers --- */
        #bg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: #111; }
        #bg-video { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; filter: blur(2px) brightness(0.8); }
        body.playing #bg-video { filter: blur(0px) brightness(0.8); opacity: 0.8; }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; z-index: 10; transition: opacity 0.3s;
        }
        .screen.active { opacity: 1; pointer-events: auto; }

        /* --- UI Components --- */
        #title-screen { background: rgba(0,0,0,0.7); }
        .btn-start {
            font-size: 1.2rem; padding: 15px 50px; background: linear-gradient(135deg, var(--primary), #3dd);
            border: none; border-radius: 50px; color: white; font-weight: bold; cursor: pointer;
            box-shadow: 0 5px 25px rgba(51, 213, 172, 0.6); text-transform: uppercase;
        }
        .btn-start:disabled { background: #555; box-shadow: none; color: #999; }

        #select-screen { background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); }
        .panel {
            background: rgba(255, 255, 255, 0.95); color: #333; width: 90%; max-width: 600px;
            padding: 25px; border-radius: 20px; display: flex; flex-direction: column; gap: 15px;
        }
        .file-drop {
            border: 2px dashed #bbb; padding: 30px; text-align: center; border-radius: 15px;
            cursor: pointer; background: #f9f9f9;
        }
        
        /* Diff Selector */
        .diff-selector { display: flex; gap: 5px; width: 100%; }
        .diff-btn {
            flex: 1; padding: 10px 0; border: none; color: white; font-weight: 900;
            cursor: pointer; opacity: 0.3; border-radius: 6px; transform: skewX(-10deg);
        }
        .diff-btn span { display: block; transform: skewX(10deg); }
        .diff-btn.selected { opacity: 1; transform: skewX(-10deg) scale(1.05); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .diff-easy { background: #69f0ae; } .diff-normal { background: #40c4ff; }
        .diff-hard { background: #ffab40; } .diff-expert { background: #ff5252; }

        /* --- Game Screen --- */
        #game-screen { pointer-events: none; }
        #game-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        .game-ui {
            position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 5;
            display: flex; flex-direction: column; justify-content: space-between; padding: 20px;
        }
        .top-bar { display: flex; justify-content: space-between; }
        .score-display { font-size: 2rem; font-family: monospace; font-weight: 900; }
        .life-bar-frame { width: 200px; height: 10px; background: rgba(0,0,0,0.5); border: 1px solid white; margin-top:5px; border-radius: 5px; overflow: hidden; }
        .life-bar { height: 100%; width: 100%; background: var(--primary); transition: width 0.1s; }

        .combo-display {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; opacity: 0; transition: transform 0.1s;
        }
        .combo-display.show { opacity: 1; }
        .combo-num { font-size: 5rem; font-weight: 900; font-style: italic; text-shadow: 0 0 20px var(--primary); }

        .judge-display {
            position: absolute; top: 65%; left: 50%; transform: translate(-50%, -50%);
            font-size: 3rem; font-weight: 900; font-style: italic; opacity: 0;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        .btn-back { pointer-events: auto; background: rgba(0,0,0,0.6); color: white; border: 1px solid white; padding: 5px 15px; border-radius: 20px; }

        /* --- Result --- */
        #result-screen { background: rgba(0,0,0,0.9); }
        .result-card { background: white; color: #333; padding: 40px; border-radius: 20px; text-align: center; min-width: 300px; }

        /* --- Loading --- */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9);
            z-index: 100; display: none; align-items: center; justify-content: center; color: white; flex-direction: column;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="bg-layer"><video id="bg-video" playsinline webkit-playsinline></video></div>
    <div id="loading-overlay"><div class="spinner"></div><div>Processing Audio...</div></div>

    <div id="title-screen" class="screen active">
        <h1 style="font-size: 3rem; color: var(--primary);">SEKAI GEN</h1>
        <p>AI RHYTHM GENERATOR</p>
        <button class="btn-start" onclick="navTo('select-screen')">START</button>
    </div>

    <div id="select-screen" class="screen">
        <div class="panel">
            <div class="file-drop" onclick="document.getElementById('file-input').click()">
                <span style="font-size: 1.2rem; font-weight: bold;">üìÇ Select Audio/Video</span><br>
                <small>MP3, WAV, MP4</small>
            </div>
            <input type="file" id="file-input" accept="audio/*,video/*" style="display: none;" onchange="handleFileSelect(this)">

            <div class="diff-selector">
                <button class="diff-btn diff-easy" onclick="setDiff(0)"><span>EASY</span></button>
                <button class="diff-btn diff-normal" onclick="setDiff(1)"><span>NORMAL</span></button>
                <button class="diff-btn diff-hard selected" onclick="setDiff(2)"><span>HARD</span></button>
                <button class="diff-btn diff-expert" onclick="setDiff(3)"><span>EXPERT</span></button>
            </div>
            
            <div>
                <label>SPEED: <span id="speed-val">9.0</span></label>
                <input type="range" min="1" max="15" step="0.5" value="9" style="width:100%;" oninput="state.noteSpeed=this.value;document.getElementById('speed-val').innerText=this.value">
            </div>

            <button class="btn-start" style="width:100%;" onclick="startGame()" id="btn-play" disabled>LOAD FILE FIRST</button>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <canvas id="game-canvas"></canvas>
        <div class="game-ui">
            <div class="top-bar">
                <div>
                    <div class="score-display" id="score">0000000</div>
                    <div class="life-bar-frame"><div class="life-bar" id="life-bar"></div></div>
                </div>
                <button class="btn-back" onclick="quitGame()">EXIT</button>
            </div>
            <div class="combo-display" id="combo-cont"><div class="combo-num" id="combo-num">0</div>COMBO</div>
            <div class="judge-display" id="judge-text">PERFECT</div>
        </div>
    </div>

    <div id="result-screen" class="screen">
        <div class="result-card">
            <h2>FINISH</h2>
            <div style="font-size:4rem; font-weight:900;" id="result-rank">S</div>
            <div>Score: <span id="result-score">0</span></div>
            <div>Max Combo: <span id="result-maxcombo">0</span></div>
            <button class="btn-start" style="margin-top:20px;" onclick="navTo('select-screen')">BACK</button>
        </div>
    </div>

<script>
/* * SEKAI GEN - REBUILT JUDGMENT CORE
 * * ‰øÆÊ≠£„Éù„Ç§„É≥„Éà:
 * 1. Âà§ÂÆö„É≠„Ç∏„ÉÉ„ÇØ„Çí„ÄåÁ∑èÂΩì„Åü„ÇäÊúÄËøëÂÇçÊé¢Á¥¢„Äç„Å´Â§âÊõ¥„ÄÇÂà§ÂÆöÊºè„Çå„ÇíÁâ©ÁêÜÁöÑ„Å´Èò≤„Åê„ÄÇ
 * 2. ÂÖ•ÂäõÂà§ÂÆöÔºàTouch/KeyÔºâ„ÇíCanvasÂ∫ßÊ®ô„Å®ÂÆåÂÖ®ÂêåÊúü„ÄÇ
 * 3. Âà§ÂÆöÂπÖ„ÇíÁ∑©Âíå„Åó„ÄÅ‰∫∫Èñì„ÅÆÊÑüË¶ö„Å´Âêà„Çè„Åõ„Çã„ÄÇ
 * 4. „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„ÉºÔºàÈï∑Êäº„ÅóÔºâ„ÅÆÂÆåÂÖ®ÁÑ°ÂäπÂåñ„ÄÇ
 */

// --- STATE ---
const state = {
    audioCtx: null,
    videoEl: document.getElementById('bg-video'),
    isPlaying: false,
    difficulty: 2,
    noteSpeed: 9.0,
    chart: [],          // ÂÖÉ„ÅÆË≠úÈù¢„Éá„Éº„Çø
    runtimeNotes: [],   // „Ç≤„Éº„É†‰∏≠„Å´Âà§ÂÆöÂá¶ÁêÜ„Åï„Çå„Çã„Éá„Éº„Çø
    score: 0,
    combo: 0,
    maxCombo: 0,
    life: 1000,
    activeLanes: [false, false, false, false], // „Ç≠„Éº„ÇíÊäº„Åó„Å¶„ÅÑ„Çã„Åã„Å©„ÅÜ„Åã„ÅÆË¶ñË¶öÁî®
    laneCount: 4
};

const CONFIG = {
    // Âà§ÂÆöÂπÖ (Áßí)
    // PERFECT: 0.08Áßí (¬±80ms) - ‰∏ÄËà¨ÁöÑ„Å™Èü≥„Ç≤„ÉºÂü∫Ê∫ñ
    // GOOD: 0.30Áßí (¬±300ms) - „Åã„Å™„ÇäÂ∫É„ÇÅ„Å´„Å®„Å£„Å¶Miss„ÇíÈò≤„Åê
    WINDOW: { PERFECT: 0.080, GREAT: 0.150, GOOD: 0.300 },
    DIFFICULTY: [
        { density: 0.6, sensitivity: 1.4 }, // EASY
        { density: 1.0, sensitivity: 1.3 }, // NORMAL
        { density: 1.8, sensitivity: 1.2 }, // HARD
        { density: 3.5, sensitivity: 1.1 }  // EXPERT
    ]
};

const CANVAS = document.getElementById('game-canvas');
const CTX = CANVAS.getContext('2d', { alpha: true });

// --- SYSTEM: Prevent Context Menu & Zoom ---
// „Åì„Çå„Å´„Çà„ÇäÈï∑Êäº„ÅóÊôÇ„ÅÆ„ÄåÂãïÁîª„Çí‰øùÂ≠ò„Äç„Å™„Å©„ÇíÈò≤„Åê
window.addEventListener('contextmenu', e => { e.preventDefault(); e.stopPropagation(); return false; }, { passive: false });
document.addEventListener('gesturestart', e => e.preventDefault());

// --- NAVIGATION ---
function navTo(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(id === 'title') { state.videoEl.pause(); state.videoEl.style.display = 'none'; }
}

function setDiff(i) {
    state.difficulty = i;
    document.querySelectorAll('.diff-btn').forEach((b, idx) => b.classList.toggle('selected', idx === i));
}

// --- FILE LOAD & ANALYZE ---
async function handleFileSelect(input) {
    if (!input.files[0]) return;
    document.getElementById('btn-play').innerText = "ANALYZING...";
    document.getElementById('loading-overlay').style.display = 'flex';
    
    if (!state.audioCtx) state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    const file = input.files[0];
    state.videoEl.src = URL.createObjectURL(file);
    state.videoEl.style.display = 'block';

    const ab = await file.arrayBuffer();
    const buffer = await state.audioCtx.decodeAudioData(ab);
    generateChart(buffer, file.name);

    document.getElementById('loading-overlay').style.display = 'none';
    document.getElementById('btn-play').innerText = "GAME START";
    document.getElementById('btn-play').disabled = false;
}

// --- CHART GENERATOR (Keep Existing Logic) ---
function generateChart(buffer, seed) {
    const data = buffer.getChannelData(0);
    const sampleRate = buffer.sampleRate;
    const conf = CONFIG.DIFFICULTY[state.difficulty];
    const notes = [];
    
    // Simple RMS & Peak detection
    const step = Math.floor(sampleRate / 60);
    let seedVal = 0; 
    for(let i=0; i<seed.length; i++) seedVal += seed.charCodeAt(i);
    const rnd = () => { seedVal = (seedVal * 9301 + 49297) % 233280; return seedVal / 233280; };

    let lastTime = -1;
    const minGap = 1.0 / (conf.density * 2.5);

    for (let i = 0; i < data.length; i += step) {
        if (i < 40) continue;
        let sum = 0;
        for(let j=0; j<step && i+j<data.length; j++) sum += data[i+j]*data[i+j];
        const rms = Math.sqrt(sum/step);
        
        if (rms > 0.1 / conf.sensitivity) { // Basic threshold
            const time = (i * step) / sampleRate;
            if (time - lastTime >= minGap) {
                // Generate Note
                let lane = Math.floor(rnd() * 4);
                let type = 'tap';
                let duration = 0;
                
                // Randomly make long notes
                if (rnd() < 0.2) {
                    type = 'long';
                    duration = 0.5 + rnd(); 
                    lastTime = time + duration * 0.8;
                } else {
                    lastTime = time;
                }

                notes.push({
                    time: time,
                    lane: lane,
                    type: type,
                    duration: duration,
                    endLane: lane, // For simplicity
                    processed: false,
                    isHolding: false
                });
            }
        }
    }
    state.chart = notes;
    console.log("Chart generated:", notes.length);
}

// --- GAME CORE ---
function startGame() {
    navTo('game-screen');
    state.score = 0; state.combo = 0; state.maxCombo = 0; state.life = 1000;
    // Deep copy notes for runtime
    state.runtimeNotes = JSON.parse(JSON.stringify(state.chart));
    state.activeLanes = [false, false, false, false];
    
    updateHUD();
    resizeCanvas();
    document.body.classList.add('playing');
    
    state.videoEl.currentTime = 0;
    state.videoEl.volume = 1.0;
    state.isPlaying = true;
    state.videoEl.play();
    
    requestAnimationFrame(loop);
}

function quitGame() {
    state.isPlaying = false;
    state.videoEl.pause();
    navTo('select-screen');
}

function finishGame() {
    state.isPlaying = false;
    document.getElementById('result-score').innerText = Math.floor(state.score);
    document.getElementById('result-maxcombo').innerText = state.maxCombo;
    
    let rank = 'C';
    const pct = state.score / (state.chart.length * 1000 || 1);
    if(pct > 0.95) rank = 'SS';
    else if(pct > 0.9) rank = 'S';
    else if(pct > 0.8) rank = 'A';
    else if(pct > 0.7) rank = 'B';
    document.getElementById('result-rank').innerText = rank;
    
    navTo('result-screen');
}

// --- NEW JUDGMENT SYSTEM ---
// Âà§ÂÆö„ÅÆÊ†∏ÂøÉÈÉ®ÂàÜ„ÄÇÂÖ•Âäõ„Åå„ÅÇ„Å£„ÅüÁû¨Èñì„ÄÅÂØæË±°„ÅÆ„É¨„Éº„É≥„Å´„ÅÇ„Çã„Éé„Éº„ÉÑ„ÇíÊé¢„Åó„Å´Ë°å„Åè
function tryHit(lane) {
    const now = state.videoEl.currentTime;
    
    // 1. „Åù„ÅÆ„É¨„Éº„É≥„Å´„ÅÇ„Çã„ÄåÊú™Âá¶ÁêÜ„Äç„Åã„Å§„ÄåÂà§ÂÆöÂúèÂÜÖ„Äç„ÅÆ„Éé„Éº„ÉÑ„ÇíÂÖ®„Å¶ÂèñÂæó
    const candidates = state.runtimeNotes.filter(n => 
        !n.processed && 
        n.lane === lane && 
        Math.abs(n.time - now) <= CONFIG.WINDOW.GOOD // GOODÁØÑÂõ≤(Â∫É„ÇÅ)„Å´ÂÖ•„Å£„Å¶„ÅÑ„Çã„ÇÇ„ÅÆÂÖ®„Å¶
    );

    // 2. ÂÄôË£ú„Åå„Å™„Åë„Çå„Å∞‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºàÁ©∫Êâì„Å°Ôºâ
    if (candidates.length === 0) return;

    // 3. ‰∏ÄÁï™Ëøë„ÅÑ„Éé„Éº„ÉÑ„ÇíÈÅ∏„Å∂Ôºà„Åì„Çå„ÅåÈáçË¶Å„ÄÇÈÖçÂàóÈ†ÜÂ∫è„Åß„ÅØ„Å™„ÅèÊôÇÈñìÂ∑Æ„ÅßÈÅ∏„Å∂Ôºâ
    candidates.sort((a, b) => Math.abs(a.time - now) - Math.abs(b.time - now));
    const target = candidates[0];
    const diff = Math.abs(target.time - now);

    // 4. Âà§ÂÆö
    let judge = 'GOOD';
    let scoreAdd = 100;

    if (diff <= CONFIG.WINDOW.PERFECT) {
        judge = 'PERFECT';
        scoreAdd = 1000;
    } else if (diff <= CONFIG.WINDOW.GREAT) {
        judge = 'GREAT';
        scoreAdd = 500;
    }

    // 5. Âá¶ÁêÜÁ¢∫ÂÆö
    if (target.type === 'long') {
        target.isHolding = true; // „É≠„É≥„Ç∞„Éé„Éº„ÉÑ„ÅØ„Åæ„Å†processed„Å´„Åó„Å™„ÅÑ
        // ÂàùÂõû„Éí„ÉÉ„ÉàÂàÜ„ÅÆÂä†ÁÇπ
        addScore(scoreAdd, judge);
    } else {
        target.processed = true;
        addScore(scoreAdd, judge);
    }
}

function releaseHold(lane) {
    // Êåá„ÇíÈõ¢„Åó„Åü„Å®„Åç„ÄÅ„Éõ„Éº„É´„Éâ‰∏≠„ÅÆ„Éé„Éº„ÉÑ„Åå„ÅÇ„Çå„Å∞Âá¶ÁêÜÂÆå‰∫Ü„Å®„Åô„Çã
    const holdingNote = state.runtimeNotes.find(n => n.lane === lane && n.isHolding && !n.processed);
    if (holdingNote) {
        const now = state.videoEl.currentTime;
        const endTime = holdingNote.time + holdingNote.duration;
        
        holdingNote.processed = true;
        holdingNote.isHolding = false;

        // ÁµÇ‰∫ÜÊôÇÈñì„Çà„ÇäÊó©„Åô„Åé„Çã„É™„É™„Éº„Çπ„ÅØMissÊâ±„ÅÑ„ÄÅ„Åù„ÅÜ„Åß„Å™„Åë„Çå„Å∞Perfect
        if (now < endTime - 0.2) {
            triggerJudgeText('MISS', '#888');
            state.combo = 0;
            state.life -= 50;
            document.getElementById('combo-cont').classList.remove('show');
        } else {
            // Á∂∫È∫ó„Å´Èõ¢„Åó„Åü
            addScore(1000, 'PERFECT'); 
        }
        updateHUD();
    }
}

function addScore(points, text) {
    state.score += points * (1 + state.combo * 0.01);
    state.combo++;
    if (state.combo > state.maxCombo) state.maxCombo = state.combo;
    state.life = Math.min(1000, state.life + (text==='PERFECT'?5:2));
    
    // Display
    const colors = { 'PERFECT': '#ffeb3b', 'GREAT': '#ff4081', 'GOOD': '#00e676' };
    triggerJudgeText(text, colors[text]);
    
    const cEl = document.getElementById('combo-cont');
    cEl.classList.add('show');
    document.getElementById('combo-num').innerText = state.combo;
    
    updateHUD();
}

function triggerJudgeText(text, color) {
    const el = document.getElementById('judge-text');
    el.innerText = text;
    el.style.color = color;
    el.style.opacity = 1;
    el.style.transform = 'translate(-50%, -50%) scale(1.5)';
    
    // CSS Animation reset hack
    requestAnimationFrame(() => {
        el.style.transition = 'all 0.1s ease-out';
        el.style.transform = 'translate(-50%, -50%) scale(1)';
        setTimeout(() => { el.style.opacity = 0; }, 200);
    });
}

function updateHUD() {
    document.getElementById('score').innerText = Math.floor(state.score).toString().padStart(7, '0');
    document.getElementById('life-bar').style.width = (state.life / 10) + '%';
}

// --- INPUT HANDLER (CANVAS COORDINATES) ---
// Â∫ßÊ®ôË®àÁÆó„ÇíÂçòÁ¥îÂåñ„Åó„ÄÅÁîªÈù¢„ÇíÂçòÁ¥î„Å´4ÂàÜÂâ≤„Åô„Çã
function getLaneFromX(clientX) {
    const width = window.innerWidth;
    const laneWidth = width / 4;
    const lane = Math.floor(clientX / laneWidth);
    return Math.max(0, Math.min(3, lane));
}

// Touch
CANVAS.addEventListener('touchstart', e => {
    e.preventDefault(); // „Åì„Çå„ÅåÈáçË¶Å
    for (let i = 0; i < e.changedTouches.length; i++) {
        const lane = getLaneFromX(e.changedTouches[i].clientX);
        state.activeLanes[lane] = true;
        tryHit(lane);
    }
}, { passive: false });

CANVAS.addEventListener('touchend', e => {
    e.preventDefault();
    for (let i = 0; i < e.changedTouches.length; i++) {
        const lane = getLaneFromX(e.changedTouches[i].clientX);
        state.activeLanes[lane] = false;
        releaseHold(lane);
    }
});

// Keyboard (D F J K)
const keys = ['d', 'f', 'j', 'k'];
window.addEventListener('keydown', e => {
    if(e.repeat) return;
    const idx = keys.indexOf(e.key.toLowerCase());
    if (idx >= 0) {
        state.activeLanes[idx] = true;
        tryHit(idx);
    }
});
window.addEventListener('keyup', e => {
    const idx = keys.indexOf(e.key.toLowerCase());
    if (idx >= 0) {
        state.activeLanes[idx] = false;
        releaseHold(idx);
    }
});

// --- RENDER LOOP ---
function loop() {
    if (!state.isPlaying) return;
    if (state.videoEl.ended) { finishGame(); return; }

    const now = state.videoEl.currentTime;

    // Clear
    CTX.clearRect(0, 0, CANVAS.width, CANVAS.height);
    CTX.fillStyle = 'rgba(0,0,0,0.3)';
    CTX.fillRect(0,0,CANVAS.width,CANVAS.height);

    // Draw Lanes
    drawLanes();

    // Draw & Update Notes
    state.runtimeNotes.forEach(note => {
        // --- MISS CHECK ---
        // „Åæ„Å†Âá¶ÁêÜ„Åï„Çå„Å¶„Åä„Çâ„Åö„ÄÅ„Åã„Å§„ÄåGoodÁØÑÂõ≤„Äç„Åô„ÇâÂÆåÂÖ®„Å´ÈÄö„ÇäÈÅé„Åé„ÅüÂ†¥Âêà„ÅÆ„ÅøMiss
        // „Åì„Çå„Å´„Çà„Çä„ÄåÊó©Êäº„Åó„Äç„ÅåMiss„Å´„Å™„Çã„Åì„Å®„ÇíÈò≤„Åê
        if (!note.processed && !note.isHolding) {
            if (now > note.time + CONFIG.WINDOW.GOOD + 0.05) { // Â∞ë„ÅóÁå∂‰∫à„ÇíÊåÅ„Åü„Åõ„Çã
                note.processed = true;
                triggerJudgeText('MISS', '#888');
                state.combo = 0;
                state.life -= 50;
                document.getElementById('combo-cont').classList.remove('show');
                updateHUD();
            }
        }

        // --- HOLDING UPDATE ---
        if (note.isHolding) {
            // „Éõ„Éº„É´„ÉâÂÆåËµ∞„ÉÅ„Çß„ÉÉ„ÇØ
            if (now >= note.time + note.duration) {
                note.isHolding = false;
                note.processed = true;
                addScore(500, 'PERFECT');
            }
        }

        // --- DRAW ---
        if (note.processed && !note.isHolding) return;

        const timeDiff = note.time - now;
        
        // Draw Long Body
        if (note.type === 'long') {
            const endDiff = (note.time + note.duration) - now;
            if (endDiff > -0.1 && timeDiff < 4) { // ÂèØË¶ñÁØÑÂõ≤
                const zHead = note.isHolding ? 0 : Math.max(0, timeDiff * state.noteSpeed);
                const zTail = Math.max(0, endDiff * state.noteSpeed);
                
                const pHead = project(note.lane, zHead);
                const pTail = project(note.endLane, zTail);

                CTX.fillStyle = 'rgba(253, 187, 45, 0.5)';
                CTX.beginPath();
                CTX.moveTo(pHead.x - pHead.w/2, pHead.y);
                CTX.lineTo(pHead.x + pHead.w/2, pHead.y);
                CTX.lineTo(pTail.x + pTail.w/2, pTail.y);
                CTX.lineTo(pTail.x - pTail.w/2, pTail.y);
                CTX.fill();
            }
        }

        // Draw Note Head
        if (!note.isHolding && timeDiff > -0.1 && timeDiff < 4) {
            const z = timeDiff * state.noteSpeed;
            const p = project(note.lane, z);
            
            const color = note.type === 'long' ? '#fdbb2d' : '#33d5ac';
            CTX.fillStyle = color;
            
            // Draw simple rect for better visibility
            CTX.fillRect(p.x - p.w/2, p.y - (20*p.s)/2, p.w, 20*p.s);
        }
    });

    requestAnimationFrame(loop);
}

// 3D Projection (Fixed Logic)
function project(lane, z) {
    // ÁîªÈù¢ÂÖ®‰Ωì„Çí4ÂàÜÂâ≤„Å®„Åó„Å¶Ë®àÁÆó„Åô„Çã
    const width = CANVAS.width;
    const height = CANVAS.height;
    
    // Ê∂àÂ§±ÁÇπ„Å®FOV
    const fov = 1.0;
    const scale = fov / (fov + z * 0.5);
    
    const horizonY = height * 0.25;
    const hitY = height * 0.85;
    
    // „É¨„Éº„É≥ÂπÖË®àÁÆó: ÁîªÈù¢ÂπÖ„ÅÑ„Å£„Å±„ÅÑ„Çí‰Ωø„ÅÜ
    const laneWidth = width / 4;
    const laneX = (lane * laneWidth) + (laneWidth / 2);
    
    // ÁîªÈù¢‰∏≠ÂøÉ„Åã„Çâ„ÅÆ„Ç™„Éï„Çª„ÉÉ„Éà
    const centerX = width / 2;
    const dx = laneX - centerX;
    
    // ÊäïÂΩ±
    const x = centerX + dx * scale;
    const y = horizonY + (hitY - horizonY) * scale;
    const w = laneWidth * scale * 0.9; // ÈöôÈñì„Çí‰Ωú„Çã„Åü„ÇÅ„Å´0.9ÂÄç
    
    return { x, y, w, s: scale };
}

function drawLanes() {
    // Draw 4 Lines
    CTX.strokeStyle = 'rgba(255,255,255,0.2)';
    CTX.lineWidth = 2;
    
    // Âå∫Âàá„ÇäÁ∑ö„ÇíÊèèÁîª
    for (let i = 0; i <= 4; i++) {
        // ‰ªÆÊÉ≥ÁöÑ„Å™„É¨„Éº„É≥Â¢ÉÁïå
        const laneX = (i * CANVAS.width / 4);
        const dx = laneX - (CANVAS.width / 2);
        
        // Far point (Z=20)
        const scaleFar = 1.0 / (1.0 + 20 * 0.5);
        const xFar = (CANVAS.width/2) + dx * scaleFar;
        const yFar = CANVAS.height * 0.25 + (CANVAS.height * 0.85 - CANVAS.height * 0.25) * scaleFar;
        
        // Near point (Z=0)
        const xNear = laneX;
        const yNear = CANVAS.height * 0.85;

        CTX.beginPath();
        CTX.moveTo(xNear, yNear);
        CTX.lineTo(xFar, yFar);
        CTX.stroke();
    }

    // Âà§ÂÆö„É©„Ç§„É≥
    CTX.strokeStyle = 'white';
    CTX.lineWidth = 3;
    CTX.beginPath();
    CTX.moveTo(0, CANVAS.height * 0.85);
    CTX.lineTo(CANVAS.width, CANVAS.height * 0.85);
    CTX.stroke();

    // „Çø„ÉÉ„ÉÅ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
    state.activeLanes.forEach((active, i) => {
        if (active) {
            const p = project(i, 0);
            CTX.fillStyle = 'rgba(51, 213, 172, 0.4)';
            CTX.fillRect(p.x - p.w/2 - 2, p.y - 100, p.w + 4, 100);
        }
    });
}

function resizeCanvas() {
    CANVAS.width = window.innerWidth;
    CANVAS.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);

</script>
</body>
</html>
