<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Éõ„É≠„ÅÆÈü≥„Ç≤„Éº + Local Video Support</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700;900&display=swap');

        :root {
            --primary: #39c5bb;
            --accent: #ff0055;
            --bg: #121212;
            --text: #ffffff;
            --success: #4caf50;
            --danger: #f44336;
            --warning: #ff9800;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: var(--bg);
            font-family: 'Exo 2', sans-serif;
            color: var(--text);
        }

        /* --- BACKGROUND LAYERS --- */
        #background-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
            overflow: hidden;
            background: #000;
            pointer-events: none;
        }

        /* YouTube Player Wrapper */
        #yt-player-container {
            position: absolute;
            top: 50%; left: 50%;
            width: 100vw; height: 100vh;
            transform: translate(-50%, -50%) scale(1.2);
            pointer-events: none;
            display: none; /* JS toggles this */
        }
        
        iframe { width: 100%; height: 100%; border: none; }

        /* Local Video Player Wrapper */
        #html5-player {
            position: absolute;
            top: 50%; left: 50%;
            min-width: 100%; min-height: 100%;
            width: auto; height: auto;
            transform: translate(-50%, -50%);
            object-fit: cover;
            display: none; /* JS toggles this */
        }

        #visualizer-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 1;
        }

        /* --- GAME LAYERS --- */
        #game-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 10;
        }

        #ui-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 20;
            pointer-events: none;
        }

        .hud-element { position: absolute; pointer-events: auto; }

        #life-container {
            top: 20px; left: 20px;
            width: 250px; height: 15px;
            background: rgba(0,0,0,0.5);
            border: 2px solid #fff;
            border-radius: 10px;
            overflow: hidden;
        }

        #life-bar {
            width: 100%; height: 100%;
            background: #4caf50;
            transition: width 0.2s, background 0.2s;
        }

        #score-display {
            top: 15px; right: 20px;
            font-size: 1.8rem;
            font-weight: 900;
            text-shadow: 2px 2px 0 #000;
            text-align: right;
        }

        #btn-quit {
            top: 50px; left: 20px;
            background: rgba(255, 50, 50, 0.8);
            border: 1px solid #fff;
            color: white;
            padding: 5px 15px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            text-transform: uppercase;
        }

        #combo-container {
            top: 35%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            display: none;
        }

        #combo-count {
            font-size: 3.0rem;
            font-weight: 900;
            background: linear-gradient(to bottom, #fff, var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1;
            filter: drop-shadow(0 0 5px rgba(57,197,187,0.5));
        }

        #combo-label {
            font-size: 0.9rem;
            letter-spacing: 5px;
            color: var(--primary);
            font-weight: bold;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
        }

        #judge-display {
            top: 60%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            font-weight: 900;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
            opacity: 0;
        }

        .judge-perfect { color: #ffeb3b; }
        .judge-great { color: #e91e63; }
        .judge-good { color: #2196f3; }
        .judge-miss { color: #9e9e9e; }

        /* --- SCREENS --- */
        .screen-container {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 100;
            pointer-events: none; 
        }

        .screen {
            position: absolute;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            transition: opacity 0.5s;
            pointer-events: auto;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .screen-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100%;
            width: 100%;
            padding: 40px 0;
        }

        .hidden { opacity: 0; pointer-events: none !important; visibility: hidden; }

        h1 { font-style: italic; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px var(--primary); margin: 0 0 20px 0; font-size: 3rem; }

        .title-logo { max-width: 100px; height: auto; margin-bottom: 10px; }

        .btn {
            background: linear-gradient(45deg, var(--primary), #2a9d8f);
            border: 2px solid #fff;
            color: white;
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 0 15px var(--primary);
            transition: transform 0.1s, background 0.2s;
            margin: 10px;
            display: inline-block;
            text-align: center;
            text-decoration: none;
        }
        .btn:active { transform: scale(0.95); }
        .btn:disabled { background: #555; box-shadow: none; cursor: not-allowed; opacity: 0.7; }

        .settings-group {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 10px;
            text-align: center;
            width: 90%;
            max-width: 600px;
            backdrop-filter: blur(5px);
        }

        .footer-container {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-footer {
            padding: 8px 20px;
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--primary);
            box-shadow: none;
            color: #fff;
            text-decoration: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn-footer:hover { background: var(--primary); color: #000; }
        .btn-cache-clear { background: rgba(255, 50, 50, 0.2); border: 1px solid #ff3232; color: #ffcccc; font-size: 0.8rem; margin-top: 15px; }

        /* --- SEARCH LIST --- */
        #search-container { position: relative; width: 100%; margin-bottom: 15px; }
        #song-search { margin-bottom: 5px; width: 100%; padding: 10px; background: #222; border: 1px solid var(--primary); color: #fff; border-radius: 5px; }
        #song-list-scroll {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #444;
            border-radius: 5px;
            background: rgba(0,0,0,0.5);
            text-align: left;
        }
        .song-item { padding: 10px; border-bottom: 1px solid #333; cursor: pointer; transition: background 0.2s; font-size: 0.95rem; }
        .song-item:hover { background: rgba(57, 197, 187, 0.2); }
        .song-item.selected { background: var(--primary); color: #000; font-weight: bold; }

        /* --- DOWNLOAD MANAGER --- */
        .download-row {
            display: flex; flex-direction: column; 
            padding: 10px; border-bottom: 1px solid #444; gap: 8px;
        }
        .dl-header { display: flex; justify-content: space-between; align-items: center; }
        .dl-title { font-weight: bold; font-size: 1rem; }
        .dl-status { font-size: 0.75rem; color: #aaa; margin-top:2px; }
        
        .dl-actions { display: flex; gap: 5px; justify-content: flex-end; align-items: center; width: 100%; }
        
        .btn-dl { padding: 5px 10px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; font-size: 0.75rem; }
        .btn-dl-get { background: var(--primary); color: #000; }
        .btn-dl-del { background: var(--danger); color: #fff; }
        .btn-vid-add { background: var(--warning); color: #000; position: relative; overflow: hidden; }
        .btn-vid-del { background: #555; color: #ccc; }
        
        .status-badge { display: inline-block; padding: 2px 5px; border-radius: 3px; font-size: 0.7rem; margin-right: 5px; }
        .badge-chart { background: var(--success); color: #fff; }
        .badge-video { background: var(--warning); color: #000; }
        
        /* File Input Hidden Overlay */
        .file-input-hidden {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer;
        }

        #download-list-scroll {
            height: 350px;
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <div id="background-layer">
        <div id="yt-player-container">
            <div id="yt-player"></div>
        </div>
        <video id="html5-player" playsinline preload="auto" muted></video>
        
        <div id="visualizer-overlay"></div>
    </div>

    <canvas id="game-layer"></canvas>

    <div id="ui-layer" class="hidden">
        <div id="life-container" class="hud-element"><div id="life-bar"></div></div>
        <button id="btn-quit" class="hud-element">QUIT</button>
        <div id="score-display" class="hud-element">SCORE: <span id="score-val">0</span></div>
        <div id="combo-container" class="hud-element">
            <div id="combo-count">0</div>
            <div id="combo-label">COMBO</div>
        </div>
        <div id="judge-display" class="hud-element">PERFECT</div>
    </div>

    <div class="screen-container">
        
        <div id="title-screen" class="screen">
            <div class="screen-content">
                <img src="https://i.imgur.com/ujQpGlp.png" alt="Logo" class="title-logo">
                <h1>„Éõ„É≠„ÅÆÈü≥„Ç≤„Éº</h1>
                <p>Offline & Video Support</p>
                <div id="loading-message">Connecting to Server...</div>
                
                <div class="settings-group hidden" id="menu-content">
                    <div style="grid-column: 1 / -1;">
                        <label>SELECT SONG</label>
                        <div id="search-container">
                            <input type="text" id="song-search" placeholder="Search song..." autocomplete="off">
                            <div id="song-list-scroll"></div>
                        </div>
                    </div>
                    <div>
                        <label>DIFFICULTY</label>
                        <select id="diff-select" style="width:100%; padding:10px; margin-bottom:15px; background:#222; color:#fff; border:1px solid var(--primary); border-radius:5px;">
                            <option value="0">EASY</option>
                            <option value="1">NORMAL</option>
                            <option value="2">HARD</option>
                            <option value="3">EXPERT</option>
                            <option value="4">MASTER</option>
                        </select>
                    </div>
                    <div>
                        <label>SPEED: <span id="speed-val">8.0</span></label>
                        <input type="range" id="speed-range" min="1" max="15" step="0.5" value="8.0" style="width:100%;">
                    </div>
                    <button id="start-btn" class="btn" disabled>SELECT A SONG</button>
                    <br>
                    <button id="btn-open-dl" class="btn-footer">üì• Download & Video Manager</button>
                </div>

                <div class="footer-container">
                    <a href="https://x.com/TanukiYy" target="_blank" class="btn btn-footer">‰ΩúËÄÖX</a>
                </div>

                <div class="footer-container2" style="margin-top:20px; text-align:center; font-size:0.8rem; color:#888;">
                    <p>ÂãïÁîª„Éï„Ç°„Ç§„É´„ÇíÁôªÈå≤„Åô„Çã„Å®„ÄÅ„Ç™„Éï„É©„Ç§„É≥„Åß„ÇÇÊò†ÂÉè‰ªò„Åç„ÅßÈÅä„Åπ„Åæ„Åô„ÄÇ<br>ÂãïÁîª„ÅØ„Éñ„É©„Ç¶„Ç∂ÂÜÖ„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åô„ÄÇ</p>
                    <button id="btn-clear-cache" class="btn btn-footer btn-cache-clear">ÂÖ®„Éá„Éº„ÇøÂâäÈô§(ÂãïÁîªÂê´„ÇÄ)</button>
                </div>
            </div>
        </div>

        <div id="download-screen" class="screen hidden">
            <div class="screen-content">
                <h2>MANAGER</h2>
                <div class="settings-group">
                    <div id="download-list-scroll"></div>
                    <button class="btn" onclick="game.closeDownloadManager()">BACK TO TITLE</button>
                </div>
            </div>
        </div>

        <div id="result-screen" class="screen hidden">
            <div class="screen-content">
                <h2 id="res-title" style="font-size:3rem; margin-bottom:10px;">FULL COMBO!</h2>
                <div style="font-size:1.5rem;">SCORE: <span id="result-score">0</span></div>
                <div style="font-size:1.2rem; margin:10px;">MAX COMBO: <span id="result-combo">0</span></div>
                <button class="btn" onclick="game.returnToTitle()">BACK TO TITLE</button>
            </div>
        </div>
        
        <div id="loading-screen" class="screen hidden" style="background:rgba(0,0,0,0.8); z-index:200;">
            <div class="screen-content">
                <h2 id="loading-text">LOADING...</h2>
            </div>
        </div>
    </div>

<script>
/**
 * AI RHYTHM GAME - Offline + Local Video Support (IndexedDB)
 */

// --- IndexedDB Wrapper for Video Storage ---
const DB_NAME = 'HoloRhythmDB';
const STORE_VIDEOS = 'videos';

class VideoStore {
    constructor() {
        this.db = null;
    }

    async open() {
        if (this.db) return;
        return new Promise((resolve, reject) => {
            const req = indexedDB.open(DB_NAME, 1);
            req.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_VIDEOS)) {
                    db.createObjectStore(STORE_VIDEOS); // Key: song json filename
                }
            };
            req.onsuccess = (e) => {
                this.db = e.target.result;
                resolve();
            };
            req.onerror = (e) => reject("DB Open Failed");
        });
    }

    async saveVideo(key, blob) {
        await this.open();
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(STORE_VIDEOS, 'readwrite');
            const store = tx.objectStore(STORE_VIDEOS);
            store.put(blob, key);
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject("Save Failed");
        });
    }

    async getVideo(key) {
        await this.open();
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(STORE_VIDEOS, 'readonly');
            const store = tx.objectStore(STORE_VIDEOS);
            const req = store.get(key);
            req.onsuccess = () => resolve(req.result); // Returns Blob or undefined
            req.onerror = () => reject("Get Failed");
        });
    }

    async deleteVideo(key) {
        await this.open();
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(STORE_VIDEOS, 'readwrite');
            const store = tx.objectStore(STORE_VIDEOS);
            store.delete(key);
            tx.oncomplete = () => resolve();
        });
    }
    
    async hasVideo(key) {
        const blob = await this.getVideo(key);
        return !!blob;
    }

    async clearAll() {
        await this.open();
        return new Promise((resolve) => {
             const tx = this.db.transaction(STORE_VIDEOS, 'readwrite');
             tx.objectStore(STORE_VIDEOS).clear();
             tx.oncomplete = () => resolve();
        });
    }
}
const videoStore = new VideoStore();

// --- Main Game Constants ---
const LANES = 4;
const PERFECT_WINDOW = 0.050;
const GREAT_WINDOW = 0.100;
const GOOD_WINDOW = 0.150;
const GAP_WINDOW = 0.150; 
const GITHUB_BASE_URL = "https://raw.githubusercontent.com/any-tls/music-notes/main/notes/";
const PROXY_BASE = "https://api.allorigins.win/raw?url=";

function getProxyUrl(filename) {
    const targetUrl = GITHUB_BASE_URL + filename;
    return PROXY_BASE + encodeURIComponent(targetUrl) + "&t=" + new Date().getTime();
}

// --- YouTube API ---
let ytPlayer;
let isYoutubeReady = false;
function onYouTubeIframeAPIReady() {
    ytPlayer = new YT.Player('yt-player', {
        height: '100%', width: '100%', videoId: '', 
        playerVars: { 'autoplay': 0, 'controls': 0, 'disablekb': 1, 'fs': 0, 'iv_load_policy': 3, 'modestbranding': 1, 'rel': 0, 'playsinline': 1 },
        events: { 'onReady': () => { isYoutubeReady = true; }, 'onStateChange': (e) => { if(e.data === YT.PlayerState.ENDED && game.isPlaying) game.finishGame(); } }
    });
}
const tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api";
document.getElementsByTagName('script')[0].parentNode.insertBefore(tag, document.getElementsByTagName('script')[0]);

// --- Game Logic ---
class RhythmGame {
    constructor() {
        this.notes = [];
        this.score = 0; this.combo = 0; this.maxCombo = 0; this.life = 1000;
        this.isPlaying = false;
        this.noteSpeed = 8.0; this.difficulty = 1;
        this.stats = { perfect:0, great:0, good:0, miss:0 };
        
        this.keyMap = { 'KeyD':0, 'KeyF':1, 'KeyJ':2, 'KeyK':3 };
        this.laneState = [0, 0, 0, 0]; 
        this.touchLaneMap = new Map(); 
        
        this.canvas = document.getElementById('game-layer');
        this.ctx = this.canvas.getContext('2d');
        this.trackDims = { x:0, w:0, laneW:0 };
        
        this.html5Video = document.getElementById('html5-player');
        this.activeVideoUrl = null; // To revoke blob URL
        this.mode = 'online'; // 'online' (YouTube) or 'local' (HTML5) or 'offline_novideo'
        
        this.resize();
        window.addEventListener('resize', () => this.resize());
        this.bindInputs();

        this.songList = [];
        this.selectedSongIndex = null;
        this.init();
    }

    async init() {
        await this.fetchSongList();
        document.getElementById('song-search').addEventListener('input', (e) => this.renderSongList(e.target.value));
        document.getElementById('btn-open-dl').addEventListener('click', () => this.openDownloadManager());
        
        // HTML5 Video Event for Ending
        this.html5Video.addEventListener('ended', () => {
            if(this.isPlaying) this.finishGame();
        });
    }

    // --- Data & List ---
    async fetchSongList() {
        try {
            const response = await fetch(getProxyUrl('note_list.txt'));
            if (!response.ok) throw new Error("Network error");
            const text = await response.text();
            this.parseSongList(text);
            localStorage.setItem('cached_song_list', text);
        } catch (e) {
            console.warn("Using cached list");
            const cached = localStorage.getItem('cached_song_list');
            if (cached) {
                this.parseSongList(cached);
                document.getElementById('loading-message').innerText = "Offline Mode: Loaded from Cache";
            } else {
                document.getElementById('loading-message').innerText = "Connection Failed & No Cache.";
            }
        }
        document.getElementById('loading-message').style.display = 'none';
        document.getElementById('menu-content').classList.remove('hidden');
        this.renderSongList("");
    }

    parseSongList(text) {
        this.songList = [];
        const regex = /(.+?)\((.+?),(.+?)\),?/g;
        let match;
        while ((match = regex.exec(text)) !== null) {
            const name = match[1].trim();
            const url = match[2].trim();
            const jsonFile = match[3].trim();
            let ytId = "";
            if (url.includes('v=')) ytId = url.split('v=')[1].split('&')[0];
            else if (url.includes('youtu.be/')) ytId = url.split('youtu.be/')[1].split('?')[0];
            this.songList.push({ name, ytId, jsonFile, originalIndex: this.songList.length });
        }
    }

    // --- Download Manager (Chart + Video) ---
    async openDownloadManager() {
        document.getElementById('title-screen').classList.add('hidden');
        document.getElementById('download-screen').classList.remove('hidden');
        await this.renderDownloadManager();
    }

    closeDownloadManager() {
        document.getElementById('download-screen').classList.add('hidden');
        document.getElementById('title-screen').classList.remove('hidden');
        this.renderSongList(document.getElementById('song-search').value);
    }

    isChartDownloaded(jsonFile) {
        return localStorage.getItem(`chart_data_${jsonFile}`) !== null;
    }

    async renderDownloadManager() {
        const container = document.getElementById('download-list-scroll');
        container.innerHTML = '';

        for (const song of this.songList) {
            const hasChart = this.isChartDownloaded(song.jsonFile);
            const hasVideo = await videoStore.hasVideo(song.jsonFile);

            const row = document.createElement('div');
            row.className = 'download-row';
            
            // Header
            const header = document.createElement('div');
            header.className = 'dl-header';
            header.innerHTML = `
                <div>
                    <div class="dl-title">${song.name}</div>
                    <div class="dl-status">
                        ${hasChart ? '<span class="status-badge badge-chart">CHART OK</span>' : ''}
                        ${hasVideo ? '<span class="status-badge badge-video">VIDEO OK</span>' : ''}
                    </div>
                </div>`;
            
            // Actions
            const actions = document.createElement('div');
            actions.className = 'dl-actions';

            // 1. Chart Controls
            if (!hasChart) {
                const btnDl = document.createElement('button');
                btnDl.className = 'btn-dl btn-dl-get';
                btnDl.innerText = "DL Chart";
                btnDl.onclick = () => this.downloadChart(song);
                actions.appendChild(btnDl);
            } else {
                const btnDel = document.createElement('button');
                btnDel.className = 'btn-dl btn-dl-del';
                btnDel.innerText = "Del Chart";
                btnDel.onclick = () => this.deleteChart(song);
                actions.appendChild(btnDel);
            }

            // 2. Video Controls
            if (!hasVideo) {
                const label = document.createElement('label');
                label.className = 'btn-dl btn-vid-add';
                label.innerHTML = `Select MP4 <input type="file" accept="video/mp4,video/webm" class="file-input-hidden">`;
                const input = label.querySelector('input');
                input.onchange = (e) => this.handleVideoSelect(song, e.target.files[0]);
                actions.appendChild(label);
            } else {
                const btnDelVid = document.createElement('button');
                btnDelVid.className = 'btn-dl btn-vid-del';
                btnDelVid.innerText = "Del Video";
                btnDelVid.onclick = () => this.deleteVideo(song);
                actions.appendChild(btnDelVid);
            }

            row.appendChild(header);
            row.appendChild(actions);
            container.appendChild(row);
        }
    }

    async downloadChart(song) {
        document.getElementById('loading-screen').classList.remove('hidden');
        document.getElementById('loading-text').innerText = "Downloading Chart...";
        try {
            const res = await fetch(getProxyUrl(song.jsonFile));
            if(!res.ok) throw new Error("Fetch failed");
            const data = await res.json();
            localStorage.setItem(`chart_data_${song.jsonFile}`, JSON.stringify(data));
            await this.renderDownloadManager();
        } catch (e) {
            alert("Failed: " + e.message);
        }
        document.getElementById('loading-screen').classList.add('hidden');
    }

    deleteChart(song) {
        if(confirm("Delete chart data?")) {
            localStorage.removeItem(`chart_data_${song.jsonFile}`);
            this.renderDownloadManager();
        }
    }

    async handleVideoSelect(song, file) {
        if (!file) return;
        if (file.size > 150 * 1024 * 1024) { // 150MB limit check (arbitrary safety)
            alert("File too large! (Limit ~150MB)");
            return;
        }
        document.getElementById('loading-screen').classList.remove('hidden');
        document.getElementById('loading-text').innerText = "Saving Video...";
        try {
            await videoStore.saveVideo(song.jsonFile, file);
            await this.renderDownloadManager();
        } catch (e) {
            alert("Error saving video: " + e);
        }
        document.getElementById('loading-screen').classList.add('hidden');
    }

    async deleteVideo(song) {
        if(confirm("Delete local video?")) {
            await videoStore.deleteVideo(song.jsonFile);
            this.renderDownloadManager();
        }
    }

    // --- Song Selection & Start ---
    async renderSongList(query) {
        const listContainer = document.getElementById('song-list-scroll');
        listContainer.innerHTML = '';
        const startBtn = document.getElementById('start-btn');
        const terms = query.toLowerCase().split(/\s+/).filter(t => t.length > 0);
        
        for (const song of this.songList) {
            // Filter
            if (terms.length > 0 && !terms.every(term => song.name.toLowerCase().includes(term))) continue;

            const div = document.createElement('div');
            div.className = 'song-item';
            
            // Check cache status for badges
            const hasChart = this.isChartDownloaded(song.jsonFile);
            const hasVideo = await videoStore.hasVideo(song.jsonFile);
            
            let badges = '';
            if (hasChart) badges += `<span class="status-badge badge-chart">C</span>`;
            if (hasVideo) badges += `<span class="status-badge badge-video">V</span>`;

            div.innerHTML = `<span>${song.name}</span> <span style="float:right;">${badges}</span>`;

            if (this.selectedSongIndex === song.originalIndex) div.classList.add('selected');
            
            div.addEventListener('click', () => {
                this.selectedSongIndex = song.originalIndex;
                document.querySelectorAll('.song-item').forEach(el => el.classList.remove('selected'));
                div.classList.add('selected');
                startBtn.disabled = false;
                startBtn.innerText = "START: " + song.name;
            });
            listContainer.appendChild(div);
        }
    }

    async loadSelectedSong() {
        if (this.selectedSongIndex === null) return;
        const song = this.songList[this.selectedSongIndex];

        document.getElementById('title-screen').classList.add('hidden');
        document.getElementById('loading-screen').classList.remove('hidden');
        document.getElementById('loading-text').innerText = "LOADING...";

        // Cleanup previous local video URL
        if (this.activeVideoUrl) {
            URL.revokeObjectURL(this.activeVideoUrl);
            this.activeVideoUrl = null;
        }
        this.html5Video.src = "";
        this.html5Video.style.display = 'none';
        document.getElementById('yt-player-container').style.display = 'none';

        try {
            // 1. Load Chart
            const cachedData = localStorage.getItem(`chart_data_${song.jsonFile}`);
            if (cachedData) {
                this.currentSongData = JSON.parse(cachedData);
            } else {
                const res = await fetch(getProxyUrl(song.jsonFile));
                if(!res.ok) throw new Error("Chart not found (Offline?)");
                this.currentSongData = await res.json();
            }
            
            const chartData = this.currentSongData.charts[this.difficulty];
            if (!chartData) throw new Error("Difficulty not found");
            this.notes = JSON.parse(JSON.stringify(chartData));
            this.notes.forEach(n => { n.lastReleaseTime=0; n.missed=false; n.finished=false; n.hit=false; n.holding=false; });

            // 2. Determine Video Source
            const localVideoBlob = await videoStore.getVideo(song.jsonFile);

            if (localVideoBlob) {
                console.log("Using Local Video");
                this.mode = 'local';
                this.activeVideoUrl = URL.createObjectURL(localVideoBlob);
                this.html5Video.src = this.activeVideoUrl;
                this.html5Video.load();
                this.html5Video.style.display = 'block';
                // Wait for video to be ready
                this.html5Video.oncanplay = () => {
                     this.html5Video.oncanplay = null; // remove listener
                     this.startGame();
                };
            } else if (navigator.onLine && isYoutubeReady) {
                console.log("Using YouTube");
                this.mode = 'online';
                document.getElementById('yt-player-container').style.display = 'block';
                ytPlayer.cueVideoById(song.ytId);
                setTimeout(() => this.startGame(), 1000);
            } else {
                console.log("No Video (Offline Mode)");
                this.mode = 'offline_novideo';
                this.startGame();
            }

        } catch (e) {
            alert("Error: " + e.message);
            this.returnToTitle();
            document.getElementById('loading-screen').classList.add('hidden');
        }
    }

    // --- Game Engine ---
    resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
        const trackW = Math.min(this.canvas.width, 800);
        this.trackDims = { x: (this.canvas.width - trackW)/2, w: trackW, laneW: trackW/LANES };
    }

    bindInputs() {
        // Keyboard
        window.addEventListener('keydown', (e) => {
            if (!this.isPlaying || e.repeat) return;
            if (e.code === 'Escape') this.stopGame();
            if (e.code in this.keyMap) { this.handleInput(this.keyMap[e.code], 'down'); this.laneState[this.keyMap[e.code]] = 1; }
        });
        window.addEventListener('keyup', (e) => {
            if (!this.isPlaying) return;
            if (e.code in this.keyMap) { this.handleInput(this.keyMap[e.code], 'up'); this.laneState[this.keyMap[e.code]] = 0; }
        });
        // Touch
        this.canvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); if(!this.isPlaying) return;
            for(let i=0;i<e.changedTouches.length;i++){
                const t=e.changedTouches[i], lane=this.getLaneFromX(t.clientX);
                if(lane!==-1){ this.touchLaneMap.set(t.identifier,lane); this.handleInput(lane,'down'); this.laneState[lane]++; }
            }
        }, {passive:false});
        const end=(e)=>{ e.preventDefault(); if(!this.isPlaying)return;
            for(let i=0;i<e.changedTouches.length;i++){
                const t=e.changedTouches[i], l=this.touchLaneMap.get(t.identifier);
                if(l!==undefined){ this.handleInput(l,'up'); this.laneState[l]=Math.max(0,this.laneState[l]-1); this.touchLaneMap.delete(t.identifier); }
            }
        };
        this.canvas.addEventListener('touchend', end); this.canvas.addEventListener('touchcancel', end);
        document.getElementById('btn-quit').addEventListener('click', () => this.stopGame());
    }

    getLaneFromX(x) {
        if (x < this.trackDims.x || x > this.trackDims.x + this.trackDims.w) return -1;
        return Math.floor((x - this.trackDims.x) / this.trackDims.laneW);
    }

    startGame() {
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('ui-layer').classList.remove('hidden');
        this.resetStats();
        
        this.isPlaying = true;
        this.startTime = Date.now(); // For offline timer

        if (this.mode === 'online') {
            ytPlayer.playVideo();
        } else if (this.mode === 'local') {
            this.html5Video.currentTime = 0;
            this.html5Video.play().catch(e => console.log("Autoplay blocked?", e));
        }
        
        this.loop();
    }

    resetStats() {
        this.score = 0; this.combo = 0; this.life = 1000;
        this.stats = { perfect:0, great:0, good:0, miss:0 };
        this.laneState = [0,0,0,0]; this.touchLaneMap.clear();
        this.updateHUD();
    }

    stopGame() {
        this.isPlaying = false;
        if (this.mode === 'online' && ytPlayer) ytPlayer.pauseVideo();
        if (this.mode === 'local') this.html5Video.pause();
        this.returnToTitle();
    }

    returnToTitle() {
        document.getElementById('result-screen').classList.add('hidden');
        document.getElementById('ui-layer').classList.add('hidden');
        document.getElementById('title-screen').classList.remove('hidden');
        this.ctx.clearRect(0,0,this.canvas.width, this.canvas.height);
        
        if (this.activeVideoUrl) {
             URL.revokeObjectURL(this.activeVideoUrl);
             this.activeVideoUrl = null;
        }
        this.html5Video.src = "";
        this.html5Video.style.display = 'none';
        document.getElementById('yt-player-container').style.display = 'none';
    }

    getCurrentTime() {
        if (!this.isPlaying) return 0;
        if (this.mode === 'online' && ytPlayer && ytPlayer.getCurrentTime) return ytPlayer.getCurrentTime();
        if (this.mode === 'local') return this.html5Video.currentTime;
        return (Date.now() - this.startTime) / 1000; // No video fallback
    }

    handleInput(lane, action) {
        const now = this.getCurrentTime();
        if (action === 'down') {
            const notes = this.notes.filter(n => !n.hit && !n.missed && n.lane===lane && n.type!=='end' && Math.abs(n.time-now)<GOOD_WINDOW);
            notes.sort((a,b)=>Math.abs(a.time-now)-Math.abs(b.time-now));
            if(notes.length>0) {
                 if(notes[0].type==='long') { notes[0].holding=true; this.judge(notes[0], now); }
                 else this.judge(notes[0], now);
            }
            // Catch holding suspended longs
            this.notes.filter(n=>n.hit && n.type==='long' && !n.holding && !n.finished && !n.missed && n.lane===lane && (now < n.time+n.length))
                .forEach(n => { if(now-n.lastReleaseTime <= GAP_WINDOW) n.holding=true; });
        } else {
            if (this.laneState[lane] <= 1) {
                this.notes.filter(n=>n.hit && n.type==='long' && n.holding && n.lane===lane && !n.finished)
                    .forEach(n => { n.holding=false; n.lastReleaseTime=now; });
            }
        }
    }

    judge(note, now) {
        const diff = Math.abs(note.time - now);
        let grade = 'MISS';
        if (diff <= PERFECT_WINDOW) grade='PERFECT';
        else if (diff <= GREAT_WINDOW) grade='GREAT';
        else if (diff <= GOOD_WINDOW) grade='GOOD';

        if (grade!=='MISS') { note.hit=true; this.addScore(grade); }
        else { note.hit=true; this.breakCombo(); }
    }

    addScore(grade) {
        this.combo++; if(this.combo>this.maxCombo) this.maxCombo=this.combo;
        let val = 500; if(grade==='PERFECT') val=1000; else if(grade==='GREAT') val=800;
        this.score += Math.floor(val*(1+Math.min(this.combo,100)*0.01));
        if(grade==='PERFECT') this.stats.perfect++; else if(grade==='GREAT') this.stats.great++; else this.stats.good++;
        this.life = Math.min(1000, this.life+15);
        this.showJudge(grade); this.updateHUD();
    }

    breakCombo() {
        this.combo = 0; this.stats.miss++; this.life = Math.max(0, this.life-50);
        this.showJudge('MISS'); this.updateHUD();
    }

    showJudge(text) {
        const el = document.getElementById('judge-display');
        el.innerText = text;
        el.className = 'judge-' + text.toLowerCase() + ' hud-element';
        el.style.animation = 'none'; el.offsetHeight; el.style.animation = 'pop 0.2s forwards'; el.style.opacity = 1;
        if(this.combo>1) {
            const c = document.getElementById('combo-container');
            document.getElementById('combo-count').innerText = this.combo;
            c.style.display = 'block'; c.style.animation='none'; c.offsetHeight; c.style.animation='bump 0.1s';
        } else document.getElementById('combo-container').style.display = 'none';
    }

    updateHUD() {
        document.getElementById('score-val').innerText = this.score;
        const bar = document.getElementById('life-bar');
        bar.style.width = (this.life/10)+'%';
        bar.style.background = this.life>300 ? '#4caf50' : '#f44336';
    }

    finishGame() {
        if(!this.isPlaying) return;
        this.isPlaying = false;
        if(this.mode==='online' && ytPlayer) ytPlayer.pauseVideo();
        if(this.mode==='local') this.html5Video.pause();
        document.getElementById('ui-layer').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('res-title').innerText = this.stats.miss===0 ? "FULL COMBO!" : "FINISH";
        document.getElementById('result-score').innerText = this.score;
        document.getElementById('result-combo').innerText = this.maxCombo;
    }

    loop() {
        if (!this.isPlaying) return;
        requestAnimationFrame(() => this.loop());
        const now = this.getCurrentTime();
        this.ctx.clearRect(0,0,this.canvas.width, this.canvas.height);

        // Drawing Logic (simplified for brevity, identical logic)
        const { x: tx, w: tw, laneW: lw } = this.trackDims;
        const project = (lx, t) => {
            const z = 1 + (t * this.noteSpeed/2); if(z<0.1) return null;
            const s = 1/z, y = this.canvas.height*0.15 + (this.canvas.height*0.75 * s);
            const x = (this.canvas.width/2) + (lx - this.canvas.width/2)*s;
            return {x, y, scale:s};
        };

        // Draw Track
        const tl=project(tx,100), tr=project(tx+tw,100), bl=project(tx,0), br=project(tx+tw,0);
        const grad = this.ctx.createLinearGradient(0,tl.y,0,bl.y);
        grad.addColorStop(0,'rgba(0,0,0,0)'); grad.addColorStop(1,'rgba(0,20,30,0.8)');
        this.ctx.fillStyle=grad; this.ctx.beginPath(); this.ctx.moveTo(bl.x,bl.y); this.ctx.lineTo(br.x,br.y); this.ctx.lineTo(tr.x,tr.y); this.ctx.lineTo(tl.x,tl.y); this.ctx.fill();

        // Lines & Beams
        this.ctx.strokeStyle='rgba(57,197,187,0.3)'; this.ctx.lineWidth=2;
        for(let i=0;i<=LANES;i++){ const p1=project(tx+i*lw,0), p2=project(tx+i*lw,100); this.ctx.beginPath(); this.ctx.moveTo(p1.x,p1.y); this.ctx.lineTo(p2.x,p2.y); this.ctx.stroke(); }
        this.ctx.strokeStyle='#fff'; this.ctx.lineWidth=4; this.ctx.beginPath(); this.ctx.moveTo(bl.x,bl.y); this.ctx.lineTo(br.x,br.y); this.ctx.stroke();

        for(let i=0;i<LANES;i++){
            if(this.laneState[i]>0){
                const p1=project(tx+i*lw,0), p2=project(tx+(i+1)*lw,0), p3=project(tx+i*lw,0.5);
                const g=this.ctx.createLinearGradient(0,p3.y,0,p1.y); g.addColorStop(0,'rgba(255,0,85,0)'); g.addColorStop(1,'rgba(255,0,85,0.6)');
                this.ctx.fillStyle=g; this.ctx.beginPath(); this.ctx.moveTo(p1.x,p1.y); this.ctx.lineTo(p2.x,p2.y); const p4=project(tx+(i+1)*lw,0.5); this.ctx.lineTo(p4.x,p4.y); this.ctx.lineTo(p3.x,p3.y); this.ctx.fill();
            }
        }

        // Draw Notes
        this.notes.forEach(n => {
            if(n.finished||n.missed)return;
            // Long logic
            if(n.type==='long' && n.hit) {
                if(now >= n.time+n.length) { n.finished=true; this.addScore('PERFECT'); return; }
                if(!n.holding && now-n.lastReleaseTime>GAP_WINDOW) { this.breakCombo(); n.missed=true; n.finished=true; return; }
            }
            const dt = n.time - now;
            if (dt > 10/(this.noteSpeed/2)) return;
            if (dt < -0.2 && n.type!=='long' && !n.hit) { n.hit=true; n.missed=true; this.breakCombo(); return; }
            if (n.type==='end' && dt<0) { this.finishGame(); return; }
            if (n.type==='end' || (n.hit && n.type!=='long')) return;

            const lx = tx + n.lane*lw;
            // Long Body
            if(n.type==='long'){
                const endDt = (n.time+n.length)-now; if(endDt<0) return;
                const startDt = n.hit ? 0 : Math.max(0, dt);
                const hp=project(lx,startDt), hpr=project(lx+lw,startDt), tp=project(lx,endDt), tpr=project(lx+lw,endDt);
                if(hp&&tp){
                    this.ctx.fillStyle = (n.hit&&!n.holding)? 'rgba(255,100,100,0.6)' : 'rgba(57,197,187,0.7)';
                    this.ctx.beginPath(); this.ctx.moveTo(hp.x,hp.y); this.ctx.lineTo(hpr.x,hpr.y); this.ctx.lineTo(tpr.x,tpr.y); this.ctx.lineTo(tp.x,tp.y); this.ctx.fill();
                }
            }
            // Note Head
            if(!n.hit){
                const p=project(lx,dt), pr=project(lx+lw,dt);
                if(p&&pr){
                    const w=pr.x-p.x, h=20*p.scale;
                    this.ctx.fillStyle = n.type==='flick'?'#ff0055':(n.type==='long'?'#ffeb3b':'#39c5bb');
                    this.ctx.fillRect(p.x+1, p.y-h/2, w-2, h);
                    this.ctx.fillStyle='#fff'; this.ctx.fillRect(p.x+3, p.y-h/4, w-6, h/2);
                    if(n.type==='flick'){
                        this.ctx.fillStyle='#ff0055'; this.ctx.beginPath(); this.ctx.moveTo(p.x+w/2,p.y-h); this.ctx.lineTo(p.x+w/2-15*p.scale,p.y-h/2); this.ctx.lineTo(p.x+w/2+15*p.scale,p.y-h/2); this.ctx.fill();
                    }
                }
            }
        });
    }
}

// Global & Listeners
const game = new RhythmGame();
document.getElementById('speed-range').addEventListener('input', (e) => { document.getElementById('speed-val').innerText = parseFloat(e.target.value).toFixed(1); game.noteSpeed = parseFloat(e.target.value); });
document.getElementById('diff-select').addEventListener('change', (e) => game.difficulty = parseInt(e.target.value));
document.getElementById('start-btn').addEventListener('click', () => { if(game.selectedSongIndex===null) alert("Select a song"); else game.loadSelectedSong(); });

// Clear All Data
document.getElementById('btn-clear-cache').addEventListener('click', async () => {
    if(confirm("Ë≠úÈù¢„Éá„Éº„Çø„Å®‰øùÂ≠ò„Åï„Çå„ÅüÂãïÁîª„ÇíÂÖ®„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) {
        localStorage.clear();
        await videoStore.clearAll();
        window.location.reload(true);
    }
});

// Styles
const styleSheet = document.createElement("style");
styleSheet.innerText = `
@keyframes pop { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1.0); opacity: 0; } }
@keyframes bump { 0% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.2); } 100% { transform: translate(-50%, -50%) scale(1); } }
`;
document.head.appendChild(styleSheet);
</script>
</body>
</html>
